<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin ‚Äî –ó–∞–∫–∞–∑—ã | ShopElectro</title>
<style>
:root{
  --bg:#121212; --panel:#1e1e1e; --muted:#2a2a2a; --accent:#ff6600; --text:#e6e6e6; --mutedText:#bfbfbf;
}
body.light{ --bg:#f6f6f6; --panel:#ffffff; --muted:#efefef; --text:#111111; --mutedText:#6b6b6b; }
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial; background:var(--bg); color:var(--text);
  -webkit-font-smoothing:antialiased; transition:background .22s,color .22s;
}
.header{
  position:sticky; top:0; z-index:60; display:flex; align-items:center; gap:12px; padding:12px 18px;
  background:var(--panel); box-shadow:0 1px 0 rgba(0,0,0,0.35);
}
.header-left{display:flex;align-items:center;gap:12px}
.home-icon{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:10px;font-size:20px}
.logo{font-weight:700}
.search{flex:1;max-width:700px;display:flex;gap:8px;align-items:center}
.search input{width:100%;padding:10px;border-radius:10px;border:none;background:var(--muted);color:var(--text)}
.search button{height:40px;padding:8px 10px;border-radius:10px;border:none;background:var(--muted);color:var(--text);cursor:pointer}
#themeToggle{width:42px;height:42px;border-radius:10px;border:none;background:var(--muted);color:var(--text);cursor:pointer}
.container{max-width:1200px;margin:20px auto;padding:16px;display:flex;flex-direction:column;gap:16px}
.controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.controls select, .controls input[type="date"], .controls input[type="text"]{
  padding:8px 10px;border-radius:8px;border:none;background:var(--muted);color:var(--text);
}
.controls button{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:#111;cursor:pointer;font-weight:700}
.controls .ghost{background:var(--muted);color:var(--text)}
.table-wrap{overflow-x:auto;background:transparent;border-radius:12px}
table{width:100%;border-collapse:collapse}
th,td{padding:10px 12px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03)}
th{color:var(--mutedText);font-weight:700}
.status-pill{padding:6px 8px;border-radius:999px;font-weight:700;display:inline-block}
.status-new{background:rgba(255,166,77,0.12);color:var(--accent)}
.status-paid{background:rgba(77,192,128,0.12);color:#4dc080}
.status-shipped{background:rgba(102,153,255,0.08);color:#6699ff}
.status-cancel{background:rgba(255,80,80,0.08);color:#ff5050}
.modal{
  position:fixed;left:50%;top:50%;transform:translate(-50%,-50%) scale(.98);
  background:var(--panel);padding:18px;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,0.6);
  max-width:920px;width:94%;max-height:86vh;overflow:auto;opacity:0;pointer-events:none;transition:all .18s;
  z-index:9999;
}
.modal.show{opacity:1;pointer-events:auto;transform:translate(-50%,-50%) scale(1)}
.modal h3{margin:0 0 12px}
.modal .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.modal pre{background:rgba(0,0,0,0.05);padding:10px;border-radius:8px;color:var(--mutedText);overflow:auto}
.empty{padding:40px;text-align:center;color:var(--mutedText);background:var(--panel);border-radius:12px}
@media(max-width:900px){
  th:nth-child(3), td:nth-child(3){display:none}
}
</style>
</head>
<body>
<header class="header" role="banner">
  <div class="header-left">
    <a class="home-icon" href="index.html" title="–ì–ª–∞–≤–Ω–∞—è">üè†</a>
    <div class="logo">ShopElectro ‚Äî –ê–¥–º–∏–Ω</div>
  </div>
  <div class="search" role="search" style="margin-right:12px">
    <input id="globalSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∑–∞–∫–∞–∑–∞–º: –Ω–æ–º–µ—Ä, email, –∏–º—è, —Ç–æ–≤–∞—Ä..." />
    <button id="searchBtn" title="–ò—Å–∫–∞—Ç—å">üîé</button>
  </div>
  <button id="themeToggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåì</button>
</header>

<main class="container" role="main">
  <div class="controls" aria-hidden="false">
    <select id="statusFilter" title="–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É">
      <option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
      <option value="new">–ù–æ–≤—ã–π</option>
      <option value="paid">–û–ø–ª–∞—á–µ–Ω</option>
      <option value="shipped">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω</option>
      <option value="cancelled">–û—Ç–º–µ–Ω—ë–Ω</option>
    </select>
    <label style="display:inline-flex;align-items:center;gap:6px;color:var(--mutedText)">
      —Å <input type="date" id="dateFrom" />
    </label>
    <label style="display:inline-flex;align-items:center;gap:6px;color:var(--mutedText)">
      –ø–æ <input type="date" id="dateTo" />
    </label>
    <input type="text" id="quickSearch" placeholder="–ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É/–∏–º–µ–Ω–∏" style="min-width:240px" />
    <button id="btnRefresh" class="ghost">–û–±–Ω–æ–≤–∏—Ç—å</button>
    <button id="btnExport">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
    <button id="btnClearAll" class="ghost" title="–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–∫–∞–∑—ã (–±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ)">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
  </div>

  <div id="tableArea" class="table-wrap" role="region" aria-label="–°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤"></div>
  <div id="empty" class="empty" style="display:none">–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –û–Ω–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.</div>
</main>

<div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
  <h3 id="modalTitle">–ó–∞–∫–∞–∑</h3>
  <div id="modalBody"></div>
  <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
    <button id="modalClose" class="ghost" style="padding:8px 10px;border-radius:8px;background:var(--muted);color:var(--text);border:none">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<script>
const ORDERS_KEY = 'orders';
function loadOrdersRaw(){ try{ const raw = localStorage.getItem(ORDERS_KEY); if(!raw) return []; return JSON.parse(raw); }catch(e){ return []; } }
function saveOrdersRaw(arr){ localStorage.setItem(ORDERS_KEY, JSON.stringify(arr)); window.dispatchEvent(new Event('storage')); }
function sampleOrdersIfEmpty(){
  const cur = loadOrdersRaw();
  if(cur.length) return;
  const now = Date.now();
  const sample = [
    {
      id: 'ORD' + (now - 600000),
      date: new Date(now - 600000).toISOString(),
      items: [{ id:1, name:'–ò–≥—Ä–æ–≤–∞—è –º—ã—à—å GX100', price:1490, qty:1 }],
      total: 1490,
      status: 'new',
      note: '',
      customer: {
        fullName: '–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤',
        email: 'ivan@example.com',
        phone: '+7 701 000 0000',
        address: '—É–ª. –õ–µ–Ω–∏–Ω–∞, –¥.1, –∫–≤.2',
        city: '–ê–ª–º–∞—Ç—ã',
        postal: '050000',
        notes: ''
      },
      delivery: 'courier',
      payment: 'card'
    },
    {
      id: 'ORD' + (now - 3600000),
      date: new Date(now - 3600000).toISOString(),
      items: [
        { id:5, name:'–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ Mechanical Pro', price:3590, qty:1 },
        { id:4, name:'–ú—ã—à—å Compact Lite', price:990, qty:1 }
      ],
      total: 4580,
      status: 'paid',
      note: '–û–ø–ª–∞—á–µ–Ω –∫–∞—Ä—Ç–æ–π',
      customer: {
        fullName: '–ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞',
        email: 'anna@example.com',
        phone: '+7 701 111 1111',
        address: '–ø—Ä. –ù–∞–∑–∞—Ä–±–∞–µ–≤–∞, –¥.10',
        city: '–ù—É—Ä-–°—É–ª—Ç–∞–Ω',
        postal: '010000',
        notes: '–ó–≤–æ–Ω–∏—Ç—å –∑–∞ —á–∞—Å'
      },
      delivery: 'pickup',
      payment: 'card'
    }
  ];
  saveOrdersRaw(sample);
}
function formatDate(iso){
  try{ const d = new Date(iso); return d.toLocaleString('ru-RU', { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' }); }catch(e){ return iso; }
}
function statusLabelClass(s){
  if(s==='new') return 'status-pill status-new';
  if(s==='paid') return 'status-pill status-paid';
  if(s==='shipped') return 'status-pill status-shipped';
  if(s==='cancelled') return 'status-pill status-cancel';
  return 'status-pill';
}
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function renderTable(){
  const all = loadOrdersRaw().slice().sort((a,b)=> new Date(b.date) - new Date(a.date));
  const statusFilter = document.getElementById('statusFilter').value;
  const qGlobal = (document.getElementById('globalSearch').value || '').trim().toLowerCase();
  const qQuick = (document.getElementById('quickSearch').value || '').trim().toLowerCase();
  const from = document.getElementById('dateFrom').value;
  const to = document.getElementById('dateTo').value;

  let filtered = all.filter(o=>{
    if(statusFilter !== 'all' && ((o.status||'') !== statusFilter)) return false;
    if(qGlobal){
      const text = (o.id + ' ' + (o.customer && o.customer.email || '') + ' ' + (o.customer && o.customer.fullName || '') + ' ' + (o.items||[]).map(i=>i.name).join(' ')).toLowerCase();
      if(!text.includes(qGlobal)) return false;
    }
    if(qQuick){
      const text = (o.id + ' ' + (o.customer && o.customer.fullName || '')).toLowerCase();
      if(!text.includes(qQuick)) return false;
    }
    if(from){
      const f = new Date(from + 'T00:00:00');
      if(new Date(o.date) < f) return false;
    }
    if(to){
      const t = new Date(to + 'T23:59:59');
      if(new Date(o.date) > t) return false;
    }
    return true;
  });

  const area = document.getElementById('tableArea');
  const empty = document.getElementById('empty');
  if(!filtered.length){
    area.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  const rows = filtered.map(o=>{
    const itemsText = (o.items || []).map(it => `${it.name} √ó${it.qty||1}`).join('; ');
    return `
      <tr data-id="${escapeHtml(o.id)}">
        <td style="min-width:200px"><strong>${escapeHtml(o.id)}</strong><div style="color:var(--mutedText);font-size:.9rem">${formatDate(o.date)}</div></td>
        <td>${escapeHtml((o.customer && o.customer.fullName) || o.customer || '')}<div style="color:var(--mutedText);font-size:.85rem">${escapeHtml((o.customer && o.customer.email) || o.user || '')}</div></td>
        <td style="max-width:380px">${escapeHtml(itemsText)}</td>
        <td>${Number(o.total || 0).toLocaleString('ru-RU')} ‚Ç∏</td>
        <td><span class="${statusLabelClass(o.status)}">${escapeHtml(o.status || '')}</span></td>
        <td style="white-space:nowrap">
          <button class="viewBtn" data-id="${escapeHtml(o.id)}">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
          <select class="statusSelect" data-id="${escapeHtml(o.id)}" style="margin-left:8px">
            <option value="new">–ù–æ–≤—ã–π</option>
            <option value="paid">–û–ø–ª–∞—á–µ–Ω</option>
            <option value="shipped">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω</option>
            <option value="cancelled">–û—Ç–º–µ–Ω—ë–Ω</option>
          </select>
          <button class="delBtn" data-id="${escapeHtml(o.id)}" style="margin-left:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);padding:6px 8px;border-radius:8px">–£–¥–∞–ª–∏—Ç—å</button>
        </td>
      </tr>
    `;
  }).join('');

  const table = `
    <table role="table" aria-label="–¢–∞–±–ª–∏—Ü–∞ –∑–∞–∫–∞–∑–æ–≤">
      <thead><tr>
        <th>–ù–æ–º–µ—Ä / –î–∞—Ç–∞</th>
        <th>–ö–ª–∏–µ–Ω—Ç</th>
        <th>–¢–æ–≤–∞—Ä—ã</th>
        <th>–°—É–º–º–∞</th>
        <th>–°—Ç–∞—Ç—É—Å</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;
  area.innerHTML = table;

  area.querySelectorAll('.viewBtn').forEach(b => b.addEventListener('click', (e)=> {
    const id = e.currentTarget.dataset.id;
    openModalFor(id);
  }));
  area.querySelectorAll('.delBtn').forEach(b => b.addEventListener('click', (e)=> {
    const id = e.currentTarget.dataset.id;
    if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑ ' + id + '?')) return;
    deleteOrder(id);
  }));
  area.querySelectorAll('.statusSelect').forEach(s => {
    const id = s.dataset.id;
    const o = loadOrdersRaw().find(x=>String(x.id) === String(id));
    if(o) s.value = o.status || 'new';
    s.addEventListener('change', (e)=> {
      changeStatus(id, e.target.value);
    });
  });
}

function openModalFor(id){
  const orders = loadOrdersRaw();
  const o = orders.find(x=>String(x.id) === String(id));
  if(!o) return alert('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω');
  const modal = document.getElementById('modal');
  const body = document.getElementById('modalBody');
  const title = document.getElementById('modalTitle');
  title.innerText = '–ó–∞–∫–∞–∑ ' + o.id;
  const itemsHtml = (o.items || []).map(it => `<li>${escapeHtml(it.name)} ‚Äî ${it.qty || 1} √ó ${Number(it.price||0).toLocaleString('ru-RU')} ‚Ç∏</li>`).join('');
  const customer = o.customer || {};
  body.innerHTML = `
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:260px">
        <div class="row"><strong>–ö–ª–∏–µ–Ω—Ç:</strong>&nbsp; ${escapeHtml(customer.fullName || o.customer || '')}</div>
        <div class="row"><strong>Email:</strong>&nbsp; ${escapeHtml(customer.email || o.user || '')}</div>
        <div class="row"><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong>&nbsp; ${escapeHtml(customer.phone || '')}</div>
        <div class="row"><strong>–ê–¥—Ä–µ—Å:</strong>&nbsp; ${escapeHtml(customer.address || '')}</div>
        <div class="row"><strong>–ì–æ—Ä–æ–¥:</strong>&nbsp; ${escapeHtml(customer.city || '')}</div>
        <div class="row"><strong>–ò–Ω–¥–µ–∫—Å:</strong>&nbsp; ${escapeHtml(customer.postal || '')}</div>
      </div>
      <div style="min-width:260px">
        <div class="row"><strong>–î–∞—Ç–∞:</strong>&nbsp; ${formatDate(o.date)}</div>
        <div class="row"><strong>–°—Ç–∞—Ç—É—Å:</strong>&nbsp; <span class="${statusLabelClass(o.status)}">${escapeHtml(o.status || '')}</span></div>
        <div class="row"><strong>–î–æ—Å—Ç–∞–≤–∫–∞:</strong>&nbsp; ${escapeHtml(o.delivery || '')}</div>
        <div class="row"><strong>–û–ø–ª–∞—Ç–∞:</strong>&nbsp; ${escapeHtml(o.payment || '')}</div>
        <div style="font-weight:800;margin-top:8px">–°—É–º–º–∞: ${Number(o.total||0).toLocaleString('ru-RU')} ‚Ç∏</div>
      </div>
    </div>
    <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0" />
    <div>
      <strong>–¢–æ–≤–∞—Ä—ã:</strong>
      <ul style="margin:8px 0 0 18px">${itemsHtml}</ul>
    </div>
    <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0" />
    <div><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong><div style="color:var(--mutedText);margin-top:6px">${escapeHtml(o.note || customer.notes || '')}</div></div>
    <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0" />
    <div><strong>–ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (JSON):</strong><pre>${escapeHtml(JSON.stringify(o, null, 2))}</pre></div>
  `;
  modal.classList.add('show');
  modal.setAttribute('aria-hidden','false');
}

function closeModal(){
  const modal = document.getElementById('modal');
  modal.classList.remove('show');
  modal.setAttribute('aria-hidden','true');
}

function deleteOrder(id){
  let arr = loadOrdersRaw();
  arr = arr.filter(x => String(x.id) !== String(id));
  saveOrdersRaw(arr);
  renderTable();
}

function changeStatus(id, newStatus){
  const arr = loadOrdersRaw();
  const idx = arr.findIndex(x => String(x.id) === String(id));
  if(idx === -1) return;
  arr[idx].status = newStatus;
  saveOrdersRaw(arr);
  renderTable();
}

function clearAllOrders(){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–∫–∞–∑—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) return;
  saveOrdersRaw([]);
  renderTable();
}

function exportCSV(){
  const arr = loadOrdersRaw();
  if(!arr.length){ alert('–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞'); return; }
  const rows = [];
  rows.push(['id','date','customer_fullName','customer_email','customer_phone','delivery','payment','status','total','items','note']);
  arr.forEach(o=>{
    const itemsText = (o.items || []).map(i => `${i.name} x${i.qty||1} (${i.price}‚Ç∏)`).join(' | ');
    const customer = o.customer || {};
    rows.push([o.id, o.date, customer.fullName || '', customer.email || '', customer.phone || '', o.delivery || '', o.payment || '', o.status || '', String(o.total || 0), itemsText, o.note || customer.notes || '']);
  });
  const csv = rows.map(r => r.map(cell => `"${String(cell || '').replace(/"/g,'""')}"`).join(',')).join('\r\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'orders_export_' + (new Date()).toISOString().slice(0,10) + '.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

document.getElementById('modalClose').addEventListener('click', closeModal);
document.getElementById('btnRefresh').addEventListener('click', renderTable);
document.getElementById('btnClearAll').addEventListener('click', clearAllOrders);
document.getElementById('btnExport').addEventListener('click', exportCSV);
document.getElementById('searchBtn').addEventListener('click', renderTable);
document.getElementById('globalSearch').addEventListener('keydown', (e)=>{ if(e.key==='Enter') renderTable(); });
document.getElementById('quickSearch').addEventListener('keydown', (e)=>{ if(e.key==='Enter') renderTable(); });
document.getElementById('statusFilter').addEventListener('change', renderTable);
document.getElementById('dateFrom').addEventListener('change', renderTable);
document.getElementById('dateTo').addEventListener('change', renderTable);

(function themeInit(){
  const THEME_KEY = 'siteTheme';
  const btn = document.getElementById('themeToggle');
  function update(){ const isLight = document.body.classList.contains('light'); btn.textContent = isLight ? 'üåû' : 'üåô'; }
  function init(){ const t = localStorage.getItem(THEME_KEY) || 'dark'; document.body.classList.toggle('light', t === 'light'); update(); }
  btn.addEventListener('click', ()=>{
    document.body.classList.toggle('light');
    const newVal = document.body.classList.contains('light') ? 'light' : 'dark';
    localStorage.setItem(THEME_KEY, newVal);
    update();
  });
  init();
})();

window.addEventListener('storage', (e)=>{ if(e.key === ORDERS_KEY || e.key === null) renderTable(); });

sampleOrdersIfEmpty();
renderTable();
</script>
</body>
</html>
